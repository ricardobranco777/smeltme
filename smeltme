#!/usr/bin/python3
"""
Parse https://smelt.suse.de/overview/ for specified groups or users
"""

import argparse
import json
import ssl
import sys

from datetime import datetime
from itertools import zip_longest
from urllib.request import urlopen
from urllib.error import HTTPError, URLError


__version__ = "1.0.0"

GROUPS = ['qam-ha', 'qam-sap']
URL = "https://smelt.suse.de/api/v1/overview/testing/"


def get_users(item):
    """
    Filter users from item['unfinished_reviews'] and return a set
    """
    users = {
        _['assigned_by_user']['username'] for _ in item['unfinished_reviews']
        if _['assigned_by_user'] is not None}
    if opts.all:
        return users
    return users & opts.user


def get_groups(item):
    """
    Filter groups from item['unfinished_reviews'] and return a set
    """
    groups = {
        _['assigned_by_group']['name'] for _ in item['unfinished_reviews']
        if _['assigned_by_group'] is not None}
    if opts.all:
        return groups
    return groups & opts.group


def get_info():
    """
    Get information
    """
    with urlopen(URL, context=ctx) as conn:
        data = json.loads(conn.read())
    results = data['results']
    while data['next'] is not None:
        with urlopen(data['next'], context=ctx) as conn:
            data = json.loads(conn.read())
        results += data['results']
    if opts.all:
        return results
    info = []
    for item in results:
        if get_users(item) or get_groups(item):
            info.append(item)
    return info


def print_info(info):
    """
    Print information
    """
    fmt = "%-30s %-10s %-11s %-4s %-4s %-25s %-30s %-12s %-20s"
    if not opts.no_header:
        print(fmt % ("ID", "SIZE", "CREATED", "DUE", "PRIO", "ASSIGNED", "PACKAGES", "VERSIONS", "REFERENCES"))
    for item in info:
        assigned = list(get_users(item))
        assigned.extend(get_groups(item))
        id_rr = "%s:%s" % (item['incident']['project'], item['request_id'])
        size = "%s %s" % (item['incident']['testsize'], item['incident']['testcomplexity'])
        created = item['created'][:len("YYYY-MM-DD")]
        enddate = datetime.fromisoformat(item['incident']['deadline'][:-1]) - datetime.utcnow()
        due = "%dd" % enddate.days
        priority = item['incident']['priority']
        packages = sorted(item['packages'])
        versions = sorted(_.split(':')[1] for _ in item['codestreams'])
        urls = sorted(_['url'] for _ in item['references'] if "suse.com" in _['url'])
        if not urls:
            urls = [""]
        print(fmt % (id_rr, size, created, due, priority, assigned[0], packages[0], versions[0], urls[0]))
        for assignee, package, version, url in zip_longest(assigned[1:], packages[1:], versions[1:], urls[1:], fillvalue=""):
            print("%63s %-25s %-30s %-12s %-20s" % (" ", assignee, package, version, url))


def parse_opts():
    """
    Parse options and arguments
    """
    parser = argparse.ArgumentParser()
    parser.add_argument(
        '-a', '--all', action='store_true',
        help="Show all. Ignore -g & -u options")
    parser.add_argument(
        '-g', '--group', action='append',
        help="Filter by group. May be specified multiple times")
    parser.add_argument(
        '-H', '--no-header', action='store_true',
        help="Do not show header")
    parser.add_argument(
        '-j', '--json', action='store_true',
        help="JSON output")
    parser.add_argument(
        '-k', '--insecure', action='store_true',
        help="Allow insecure server connections when using SSL")
    parser.add_argument(
        '-u', '--user', action='append',
        help="Filter by user. May be specified multiple times")
    parser.add_argument(
        '-V', '--version', action='store_true',
        help="Show version and exit")
    return parser.parse_args()


def main():
    """
    Main function
    """
    info = get_info()
    if opts.json:
        print(json.dumps(info))
    else:
        print_info(info)


if __name__ == "__main__":
    opts = parse_opts()
    if opts.version:
        print(__version__)
        sys.exit(0)
    if not opts.user and not opts.group:
        opts.group = GROUPS
    opts.user = set(opts.user) if opts.user else set()
    opts.group = set(opts.group) if opts.group else set()
    if opts.all:
        opts.user, opts.group = None, None
    ctx = ssl.create_default_context()
    if opts.insecure:
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
    # Check if host is accessible
    try:
        urlopen("https://smelt.suse.de/static/img/favicon.ico", context=ctx)
    except (HTTPError, URLError) as err:
        print("ERROR: %s" % err.reason, file=sys.stderr)
        sys.exit(1)
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(1)
